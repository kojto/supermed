<odoo>
    <data>
        <template id="kojto_finance.report_kojto_invoices">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="doc">
                    <div class="page">
                        <t t-set="company_contact" t-value="env['kojto.contacts'].search([('res_company_id', '=', env.company.id)], limit=1)" />
                        <t t-if="company_contact and company_contact.company_logo">
                            <t t-set="company_logo" t-value="'data:image/svg;base64,' + company_contact.company_logo.decode('utf-8')" />
                            <style> @page { @top-right { content: url("<t t-out='company_logo' />"); vertical-align: bottom; padding-top: 20px; max-width: 150px; } } </style>
                        </t>
                        <div t-attf-style="string-set: date_issue '{{ doc.date_issue.strftime('%Y-%m-%d') if doc.date_issue else '' }}';">
                            <div class="info-section">
                                <div class="info-cell">
                                    <table class="info-table">
                                        <tr t-if="doc.invoice_type == 'invoice'">
                                            <td class="label"><h1>INVOICE </h1></td>
                                            <td class="content"><h1><span t-field="doc.consecutive_number" /></h1></td>
                                        </tr>
                                        <tr t-if="doc.invoice_type == 'proforma'">
                                            <td class="label"><h1>PROFORMA </h1></td>
                                            <td class="content"><h1><span t-field="doc.consecutive_number" /></h1></td>
                                        </tr>
                                        <tr t-if="doc.invoice_type == 'credit_note'">
                                            <td class="label"><h1>CREDIT NOTE </h1></td>
                                            <td class="content"><h1><span t-field="doc.consecutive_number" /></h1></td>
                                        </tr>
                                        <tr t-if="doc.invoice_type == 'debit_note'">
                                            <td class="label"><h1>DEBIT NOTE </h1></td>
                                            <td class="content"><h1><span t-field="doc.consecutive_number" /></h1></td>
                                        </tr>
                                        <tr t-if="doc.invoice_type == 'insurance_policy'">
                                            <td class="label"><h1>INSURANCE POLICY </h1></td>
                                            <td class="content"><h1><span t-field="doc.consecutive_number" /></h1></td>
                                        </tr>
                                        <tr t-if="doc.invoice_type != 'invoice' and doc.invoice_type != 'proforma' and doc.invoice_type != 'credit_note' and doc.invoice_type != 'debit_note' and doc.invoice_type != 'insurance_policy'">
                                            <td class="label"></td>
                                            <td class="content"><h1><span t-field="doc.consecutive_number" /></h1></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="info-section">
                            <div class="info-cell" t-if="doc.document_in_out_type == 'outgoing'">
                                <table class="info-table">
                                    <tr>
                                        <td class="label">Issued by:</td>
                                        <td class="content"><span t-out="doc.company_name_id" /></td>
                                    </tr>
                                    <tr>
                                        <td class="label">Address:</td>
                                        <td class="content"><span t-out="doc.company_address_id" /></td>
                                    </tr>
                                    <tr t-if="doc.company_tax_number_id">
                                        <td class="label">Tax ID:</td>
                                        <td class="content" t-out="doc.company_tax_number_id.tax_number" />
                                    </tr>
                                    <tr t-if="doc.company_registration_number">
                                        <td class="label"><span t-out="doc.company_registration_number_type or 'Reg. #'" />:</td>
                                        <td class="content" t-out="doc.company_registration_number" />
                                    </tr>
                                    <tr t-if="doc.company_bank_account_id">
                                        <td class="label">IBAN:</td>
                                        <td class="content">
                                            <span t-out="doc.company_bank_account_id.IBAN or ''" />
                                            <span t-if="doc.company_bank_account_id and doc.company_bank_account_id.currency_id" t-out="'(' + doc.company_bank_account_id.currency_id.name + ')'" />
                                        </td>
                                    </tr>
                                    <tr t-if="doc.company_bank_account_id.BIC">
                                        <td class="label">BIC:</td>
                                        <td class="content" t-out="doc.company_bank_account_id.BIC or ''" />
                                    </tr>
                                    <tr t-if="doc.company_bank_account_id.bank_id">
                                        <td class="label">Bank:</td>
                                        <td class="content" t-out="doc.company_bank_account_id.bank_id.name or ''" />
                                    </tr>
                                    <tr t-if="doc.issued_by_name_id">
                                        <td class="label">Prepared by:</td>
                                        <td class="content"><span t-field="doc.issued_by_name_id" /></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="info-cell" t-if="doc.document_in_out_type == 'outgoing'">
                                <table class="info-table">
                                    <tr>
                                        <td class="label">Issued to:</td>
                                        <td class="content"><span t-field="doc.counterparty_id.name" /></td>
                                    </tr>
                                    <tr t-if="doc.counterparty_address_id">
                                        <td class="label">Address:</td>
                                        <td class="content"><span t-field="doc.counterparty_address_id" /></td>
                                    </tr>
                                    <tr t-if="doc.counterparty_tax_number_id">
                                        <td class="label">Tax ID:</td>
                                        <td class="content" t-out="doc.counterparty_tax_number_id.tax_number" />
                                    </tr>
                                    <tr t-if="doc.counterparty_registration_number">
                                        <td class="label"><span t-out="doc.counterparty_registration_number_type or 'Reg. #'" />:</td>
                                        <td class="content" t-out="doc.counterparty_registration_number" />
                                    </tr>
                                    <tr t-if="doc.counterparty_bank_account_id.IBAN">
                                        <td class="label">IBAN:</td>
                                        <td class="content">
                                            <span t-out="doc.counterparty_bank_account_id.IBAN or ''" />
                                            <span t-if="doc.counterparty_bank_account_id and doc.counterparty_bank_account_id.currency_id" t-out="'(' + doc.counterparty_bank_account_id.currency_id.name + ')'" />
                                        </td>
                                    </tr>
                                    <tr t-if="doc.counterparty_bank_account_id.BIC">
                                        <td class="label">BIC:</td>
                                        <td class="content" t-out="doc.counterparty_bank_account_id.BIC or ''" />
                                    </tr>
                                    <tr t-if="doc.counterparty_bank_account_id.bank_id">
                                        <td class="label">Bank:</td>
                                        <td class="content" t-out="doc.counterparty_bank_account_id.bank_id.name or ''" />
                                    </tr>
                                </table>
                            </div>
                            <div class="info-cell" t-if="doc.document_in_out_type == 'incoming'">
                                <table class="info-table">
                                    <tr>
                                        <td class="label">Issued by:</td>
                                        <td class="content"><span t-field="doc.counterparty_id" /></td>
                                    </tr>
                                    <tr t-if="doc.counterparty_address_id">
                                        <td class="label">Address:</td>
                                        <td class="content"><span t-field="doc.counterparty_address_id" /></td>
                                    </tr>
                                    <tr t-if="doc.counterparty_tax_number_id">
                                        <td class="label">Tax ID:</td>
                                        <td class="content" t-out="doc.counterparty_tax_number_id.tax_number" />
                                    </tr>
                                    <tr t-if="doc.counterparty_registration_number">
                                        <td class="label"><span t-out="doc.counterparty_registration_number_type or 'Reg. #'" />:</td>
                                        <td class="content" t-out="doc.counterparty_registration_number" />
                                    </tr>
                                    <tr t-if="doc.counterparty_bank_account_id.IBAN">
                                        <td class="label">IBAN:</td>
                                        <td class="content">
                                            <span t-out="doc.counterparty_bank_account_id.IBAN or ''" />
                                            <span t-if="doc.counterparty_bank_account_id and doc.counterparty_bank_account_id.currency_id" t-out="'(' + doc.counterparty_bank_account_id.currency_id.name + ')'" />
                                        </td>
                                    </tr>
                                    <tr t-if="doc.counterparty_bank_account_id.BIC">
                                        <td class="label">BIC:</td>
                                        <td class="content" t-out="doc.counterparty_bank_account_id.BIC or ''" />
                                    </tr>
                                    <tr t-if="doc.counterparty_bank_account_id.bank_id">
                                        <td class="label">Bank:</td>
                                        <td class="content" t-out="doc.counterparty_bank_account_id.bank_id.name or ''" />
                                    </tr>
                                </table>
                            </div>
                            <div class="info-cell" t-if="doc.document_in_out_type == 'incoming'">
                                <table class="info-table">
                                    <tr>
                                        <td class="label">Issued to:</td>
                                        <td class="content"><span t-field="doc.company_name_id" /></td>
                                    </tr>
                                    <tr t-if="doc.company_address_id">
                                        <td class="label">Address:</td>
                                        <td class="content"><span t-field="doc.company_address_id" /></td>
                                    </tr>
                                    <tr t-if="doc.company_tax_number_id">
                                        <td class="label">Tax ID:</td>
                                        <td class="content" t-out="doc.company_tax_number_id.tax_number" />
                                    </tr>
                                    <tr t-if="doc.company_registration_number">
                                        <td class="label"><span t-out="doc.company_registration_number_type or 'Reg. #'" />:</td>
                                        <td class="content" t-out="doc.company_registration_number" />
                                    </tr>
                                    <tr t-if="doc.company_bank_account_id.IBAN">
                                        <td class="label">IBAN:</td>
                                        <td class="content">
                                            <span t-out="doc.company_bank_account_id.IBAN or ''" />
                                            <span t-if="doc.company_bank_account_id and doc.company_bank_account_id.currency_id" t-out="'(' + doc.company_bank_account_id.currency_id.name + ')'" />
                                        </td>
                                    </tr>
                                    <tr t-if="doc.company_bank_account_id.BIC">
                                        <td class="label">BIC:</td>
                                        <td class="content" t-out="doc.company_bank_account_id.BIC or ''" />
                                    </tr>
                                    <tr t-if="doc.company_bank_account_id.bank_id">
                                        <td class="label">Bank:</td>
                                        <td class="content" t-out="doc.company_bank_account_id.bank_id.name or ''" />
                                    </tr>
                                    <tr t-if="doc.issued_by_name_id">
                                        <td class="label">Prepared by:</td>
                                        <td class="content"><span t-field="doc.issued_by_name_id" /></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div class="body">
                            <div class="info-section">
                                <div class="info-cell">
                                    <table class="info-table">
                                        <tr t-if="doc.name">
                                            <td class="label">Our Reference:</td>
                                            <td class="content" t-out="doc.name" />
                                        </tr>
                                        <tr t-if="doc.counterpartys_reference">
                                            <td class="label">Your Reference:</td>
                                            <td class="content" t-out="doc.counterpartys_reference" />
                                        </tr>
                                        <tr t-if="doc.payment_terms_id">
                                            <td class="label">Terms of Payment:</td>
                                            <td class="content" t-out="doc.payment_terms_id.name" />
                                        </tr>
                                    </table>
                                </div>
                                <div class="info-cell">
                                    <table class="info-table">
                                        <tr>
                                            <td class="label">Issue Date:</td>
                                            <td class="content" t-out="doc.date_issue.strftime('%d.%m.%Y') if doc.date_issue else ''" />
                                        </tr>
                                        <tr>
                                            <td class="label">Due Date:</td>
                                            <td class="content" t-out="doc.date_due.strftime('%d.%m.%Y') if doc.date_due else ''" />
                                        </tr>
                                        <tr>
                                            <td class="label">Tax Event Date:</td>
                                            <td class="content" t-out="doc.date_tax_event.strftime('%d.%m.%Y') if doc.date_tax_event else ''" />
                                        </tr>

                                        <tr t-if="doc.invoice_type in ['credit_note', 'debit_note'] and doc.parent_invoice_id">
                                            <td class="label">To Invoice id:</td>
                                            <td class="content" t-out="doc.parent_invoice_id.consecutive_number" />
                                        </tr>
                                        <tr t-if="doc.invoice_type in ['credit_note', 'debit_note'] and doc.parent_invoice_id">
                                            <td class="label">Parent Invoice Date:</td>
                                            <td class="content" t-out="doc.parent_invoice_date_issue.strftime('%d.%m.%Y') if doc.parent_invoice_date_issue else ''" />
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            <br/>
                            <div t-out="doc.pre_content_text" style="white-space: pre-wrap; margin-top: 10px;" t-if="doc.pre_content_text" />
                            <table class="content-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Description</th>
                                        <th style="text-align: right" class="ko-w-70">Quantity</th>
                                        <th style="text-align: right" class="ko-w-70">Unit Price</th>
                                        <th style="text-align: right" class="ko-w-70">Pre VAT Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="doc.content" t-as="line">
                                        <tr>
                                            <td t-out="line.position if line.position else '-'" />
                                            <td t-out="line.name if line.name else '-'" />
                                            <td style="text-align: right">
                                                <t t-if="line.unit_id">
                                                    <t t-set="translated_unit_name"
                                                        t-value="line.unit_id.translation_ids.filtered(lambda t: t.language_id.code == env.context.get('lang', 'en_US')).name or line.unit_id.name" />
                                                    <t t-out="'%.2f %s' % (line.quantity, translated_unit_name) if line.quantity or line.quantity == 0 else '-'" />
                                                </t>
                                                <t t-else="">
                                                    <t t-out="'%.2f' % line.quantity if line.quantity or line.quantity == 0 else '-'" />
                                                </t>
                                            </td>
                                            <td style="text-align: right" t-out="'%.2f %s' % (line.unit_price, doc.currency_id.name) if line.unit_price or line.unit_price == 0 else '-'" />
                                            <td style="text-align: right" t-out="'%.2f %s' % (line.pre_vat_total, doc.currency_id.name) if line.pre_vat_total or line.pre_vat_total == 0 else '-'" />
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                            <div t-out="doc.post_content_text" style="white-space: pre-wrap;" />
                            <div style="page-break-inside: avoid; display: inline-block; width: 100%;">
                                <table class="totals-table">
                                    <tr>
                                        <td>Net Sum:</td>
                                        <td t-out="'%.2f %s' % (doc.pre_vat_total, doc.currency_id.name)" />
                                    </tr>
                                    <tr>
                                        <td>Vat Total:</td>
                                        <td t-if="doc.custom_vat == 0" t-out="'%.2f %s' % (doc.vat_total, doc.currency_id.name)" />
                                        <td t-if="doc.custom_vat != 0" t-out="'%.2f %s' % (doc.custom_vat, doc.currency_id.name)" />
                                    </tr>
                                    <tr>
                                        <td>Total Amount:</td>
                                        <td t-out="'%.2f %s' % (doc.total_price, doc.currency_id.name)" />
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div class="vat-treatment-summary">
                            <strong>VAT Treatment Summary:</strong>
                            <t t-set="vat_treatment_groups" t-value="{}" />
                            <t t-foreach="doc.content" t-as="line">
                                <t t-if="line.vat_treatment_id">
                                    <t t-set="current_lang" t-value="env.context.get('lang', 'en_US')" />
                                    <t t-set="translated_vat" t-value="line.vat_treatment_id.translation_ids.filtered(lambda t: t.language_id.code == current_lang).description or line.vat_treatment_id.display_name" />
                                    <t t-set="vat_key" t-value="translated_vat or 'None'" />
                                    <t t-set="vat_treatment_groups"
                                        t-value="dict(vat_treatment_groups, **{vat_key: vat_treatment_groups.get(vat_key, []) + [line.position or '']})" />
                                </t>
                            </t>
                            <t t-foreach="vat_treatment_groups" t-as="vat_group">
                                <p t-out="'%s (position %s)' % (vat_group, ', '.join([pos for pos in vat_treatment_groups[vat_group] if pos]))" />
                            </t>
                        </div>
                        <div class="vat-rate-summary">
                            <strong>VAT Rate Summary:</strong>
                            <t t-set="vat_rate_groups" t-value="{}" />
                            <t t-foreach="doc.content" t-as="line">
                                <t t-if="line.vat_rate or line.vat_rate == 0">
                                    <t t-set="vat_rate_key" t-value="'%.2f' % line.vat_rate" />
                                    <t t-set="vat_rate_groups"
                                        t-value="dict(vat_rate_groups, **{vat_rate_key: vat_rate_groups.get(vat_rate_key, []) + [line.position or '']})" />
                                </t>
                            </t>
                            <t t-foreach="vat_rate_groups" t-as="vat_rate_group">
                                <p t-out="'{}% (position {})'.format(vat_rate_group, ', '.join([pos for pos in vat_rate_groups[vat_rate_group] if pos]))" />
                            </t>
                        </div>
                        <div class="footer-section">
                            <p>---- КРАЙ НА ДОКУМЕНТА ----</p>
                        </div>
                    </div>
                </t>
            </t>
        </template>
    </data>
</odoo>
